<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«ã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ— - ç„¡é™æ°´å¹³æ€è€ƒã‚¯ã‚¤ã‚º</title>
  <meta name="description" content="AIãŒç„¡é™ã«ç”Ÿæˆã™ã‚‹æ°´å¹³æ€è€ƒã‚¯ã‚¤ã‚ºã€Œã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—ã€ã€‚è³ªå•ã‚’é‡ã­ã¦çœŸç›¸ã‚’è§£ãæ˜ã‹ãã†ï¼">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¢</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a1628;
      --bg-secondary: #0f2744;
      --accent: #00d9ff;
      --accent-glow: rgba(0, 217, 255, 0.3);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --yes-color: #4ade80;
      --no-color: #f87171;
      --maybe-color: #fbbf24;
      --correct-color: #a855f7;
      --error-color: #ef4444;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #1a3a5c 100%);
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
    }

    /* Animated background */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .bubble {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(0, 217, 255, 0.2), transparent);
      animation: float 20s infinite ease-in-out;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }

      10% {
        opacity: 0.6;
      }

      90% {
        opacity: 0.6;
      }

      100% {
        transform: translateY(-100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--error-color);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--yes-color);
      color: var(--bg-primary);
    }

    /* Container */
    .container {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Glass card */
    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    /* Screens */
    .screen {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Start Screen */
    #start-screen {
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }

    .logo {
      margin-bottom: 20px;
    }

    .logo .turtle {
      font-size: 80px;
      animation: swim 3s ease-in-out infinite;
    }

    @keyframes swim {

      0%,
      100% {
        transform: translateX(0) rotate(-5deg);
      }

      50% {
        transform: translateX(10px) rotate(5deg);
      }
    }

    .title {
      font-size: clamp(2rem, 8vw, 3.5rem);
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
      text-shadow: 0 0 60px var(--accent-glow);
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 30px;
      line-height: 1.8;
    }

    /* Difficulty Selector */
    .difficulty-selector {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .difficulty-btn {
      padding: 12px 24px;
      border: 2px solid var(--glass-border);
      background: var(--glass);
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .difficulty-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .difficulty-btn.active {
      background: linear-gradient(135deg, var(--accent), #0099cc);
      border-color: transparent;
      color: var(--bg-primary);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .difficulty-btn.easy.active {
      background: linear-gradient(135deg, var(--yes-color), #22c55e);
      box-shadow: 0 4px 20px rgba(74, 222, 128, 0.3);
    }

    .difficulty-btn.normal.active {
      background: linear-gradient(135deg, var(--accent), #0099cc);
    }

    .difficulty-btn.hard.active {
      background: linear-gradient(135deg, var(--no-color), #dc2626);
      box-shadow: 0 4px 20px rgba(248, 113, 113, 0.3);
    }

    .difficulty-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .start-btn {
      background: linear-gradient(135deg, var(--accent), #0099cc);
      border: none;
      padding: 18px 48px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--bg-primary);
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 30px var(--accent-glow);
      font-family: inherit;
    }

    .start-btn:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 40px var(--accent-glow);
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Game Screen */
    #game-screen {
      padding-top: 20px;
      gap: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--glass);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
    }

    .game-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .question-count {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .question-count span {
      color: var(--accent);
      font-weight: 700;
    }

    /* Problem Card */
    .problem-card {
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(168, 85, 247, 0.1));
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 28px;
      position: relative;
      overflow: hidden;
    }

    .problem-card::before {
      content: 'â“';
      position: absolute;
      top: -20px;
      right: -20px;
      font-size: 100px;
      opacity: 0.1;
    }

    .problem-label {
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 12px;
    }

    .problem-text {
      font-size: 1.15rem;
      line-height: 1.9;
      color: var(--text-primary);
    }

    /* Input Area */
    .input-area {
      display: flex;
      gap: 12px;
    }

    .question-input {
      flex: 1;
      background: var(--glass);
      border: 2px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px 20px;
      font-size: 1rem;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .question-input::placeholder {
      color: var(--text-secondary);
    }

    .question-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .send-btn {
      background: linear-gradient(135deg, var(--accent), #0099cc);
      border: none;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* History */
    .history-section {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .history-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 8px;
      max-height: 300px;
    }

    .history-list::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
      background: var(--glass);
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }

    .history-item {
      display: flex;
      gap: 12px;
      padding: 14px;
      background: var(--glass);
      border-radius: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .history-q {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .history-a {
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .history-a.yes {
      background: rgba(74, 222, 128, 0.2);
      color: var(--yes-color);
    }

    .history-a.no {
      background: rgba(248, 113, 113, 0.2);
      color: var(--no-color);
    }

    .history-a.maybe {
      background: rgba(251, 191, 36, 0.2);
      color: var(--maybe-color);
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .action-btn {
      flex: 1;
      min-width: 140px;
      padding: 14px 20px;
      border: 2px solid var(--glass-border);
      background: var(--glass);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .action-btn:hover:not(:disabled) {
      border-color: var(--accent);
      background: rgba(0, 217, 255, 0.1);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, var(--correct-color), #7c3aed);
      border: none;
      color: white;
    }

    .action-btn.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }

    /* Result Screen */
    #result-screen {
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }

    .result-card {
      width: 100%;
      max-width: 500px;
    }

    .result-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 1s ease infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .result-title {
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--yes-color), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .result-title.giveup {
      background: linear-gradient(135deg, var(--maybe-color), var(--no-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .answer-section {
      background: var(--glass);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      text-align: left;
    }

    .answer-label {
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 12px;
    }

    .answer-text {
      font-size: 1.1rem;
      line-height: 1.8;
      color: var(--text-primary);
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 32px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 900;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .next-btn {
      background: linear-gradient(135deg, var(--accent), #0099cc);
      border: none;
      padding: 16px 40px;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--bg-primary);
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 30px var(--accent-glow);
      font-family: inherit;
    }

    .next-btn:hover {
      transform: translateY(-3px) scale(1.05);
    }

    /* Loading */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
      margin-left: 8px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      background: currentColor;
      border-radius: 50%;
      animation: loadingDot 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes loadingDot {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 100;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .modal h3 {
      font-size: 1.3rem;
      margin-bottom: 16px;
      color: var(--accent);
    }

    .modal p {
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-input {
      width: 100%;
      background: var(--glass);
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 1rem;
      color: var(--text-primary);
      font-family: inherit;
      margin-bottom: 20px;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      font-size: 1rem;
    }

    .modal-btn.cancel {
      background: var(--glass);
      border: 2px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .modal-btn.confirm {
      background: linear-gradient(135deg, var(--accent), #0099cc);
      border: none;
      color: var(--bg-primary);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }

      .glass-card {
        padding: 20px;
      }

      .problem-card {
        padding: 20px;
      }

      .title {
        font-size: 2rem;
      }

      .input-area {
        flex-direction: column;
      }

      .send-btn {
        width: 100%;
        height: 50px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-btn {
        width: 100%;
      }

      .stats {
        gap: 20px;
      }
    }
  </style>
</head>

<body>
  <!-- Background Animation -->
  <div class="bg-animation" id="bg-animation"></div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Guess Modal -->
  <div class="modal-overlay" id="guess-modal">
    <div class="modal">
      <h3>âœ¨ çœŸç›¸ã‚’æ¨ç†ã™ã‚‹</h3>
      <p>çœŸç›¸ã ã¨æ€ã†å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ ¸å¿ƒãŒåˆã£ã¦ã„ã‚Œã°æ­£è§£ã§ã™ï¼</p>
      <textarea class="modal-input" id="guess-input" rows="4" placeholder="ä¾‹ï¼šç”·ã¯å®Ÿã¯...ã ã£ãŸ"></textarea>
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="guess-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" id="guess-submit">åˆ¤å®šã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Start Screen -->
    <div class="screen active" id="start-screen">
      <div class="glass-card">
        <div class="logo">
          <div class="turtle">ğŸ¢</div>
        </div>
        <h1 class="title">ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«<br>ã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—</h1>
        <p class="subtitle">
          AIãŒç„¡é™ã«ç”Ÿã¿å‡ºã™æ°´å¹³æ€è€ƒã‚¯ã‚¤ã‚ºã€‚<br>
          ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ã®è³ªå•ã‚’é‡ã­ã¦<br>
          è¬ã®çœŸç›¸ã‚’è§£ãæ˜ã‹ã›ï¼
        </p>

        <div class="difficulty-label">ğŸ¯ é›£æ˜“åº¦ã‚’é¸æŠ</div>
        <div class="difficulty-selector">
          <button class="difficulty-btn easy active" data-difficulty="easy">ğŸŒ± åˆç´š</button>
          <button class="difficulty-btn normal" data-difficulty="normal">ğŸŒŠ ä¸­ç´š</button>
          <button class="difficulty-btn hard" data-difficulty="hard">ğŸ”¥ ä¸Šç´š</button>
        </div>

        <button class="start-btn" id="start-btn">ğŸ® ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <!-- Game Screen -->
    <div class="screen" id="game-screen">
      <div class="header">
        <div class="game-title">ğŸ¢ ã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—</div>
        <div class="question-count">è³ªå•å›æ•°: <span id="question-count">0</span></div>
      </div>

      <div class="problem-card">
        <div class="problem-label">ğŸ“œ å•é¡Œ</div>
        <p class="problem-text" id="problem-text">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <div class="input-area">
        <input type="text" class="question-input" id="question-input" placeholder="è³ªå•ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãã®äººã¯ç”·æ€§ã§ã™ã‹ï¼Ÿï¼‰">
        <button class="send-btn" id="send-btn">ğŸš€</button>
      </div>

      <div class="history-section">
        <div class="history-label">ğŸ’¬ è³ªå•å±¥æ­´</div>
        <div class="history-list" id="history-list"></div>
      </div>

      <div class="action-buttons">
        <button class="action-btn" id="hint-btn">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
        <button class="action-btn primary" id="answer-btn">âœ¨ æ­£è§£ã‚’æ¨ç†</button>
        <button class="action-btn" id="giveup-btn">ğŸ³ï¸ ã‚®ãƒ–ã‚¢ãƒƒãƒ—</button>
      </div>
    </div>

    <!-- Result Screen -->
    <div class="screen" id="result-screen">
      <div class="glass-card result-card">
        <div class="result-icon" id="result-icon">ğŸ‰</div>
        <h2 class="result-title" id="result-title">æ­£è§£ï¼</h2>

        <div class="answer-section">
          <div class="answer-label">ğŸ“– çœŸç›¸</div>
          <p class="answer-text" id="answer-text"></p>
        </div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="final-question-count">0</div>
            <div class="stat-label">è³ªå•å›æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="yes-count">0</div>
            <div class="stat-label">ã¯ã„</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="no-count">0</div>
            <div class="stat-label">ã„ã„ãˆ</div>
          </div>
        </div>

        <button class="next-btn" id="next-btn">ğŸ”„ æ¬¡ã®å•é¡Œã¸</button>
      </div>
    </div>
  </div>

  <script>
    // API endpoint (Vercel serverless function)
    const API_ENDPOINT = '/api/chat';

    // Game State
    let gameState = {
      problem: '',
      answer: '',
      questionCount: 0,
      yesCount: 0,
      noCount: 0,
      history: [],
      isLoading: false,
      difficulty: 'easy'
    };

    // Difficulty configurations
    const difficultyConfig = {
      easy: {
        label: 'åˆç´š',
        prompt: `ã€é›£æ˜“åº¦ï¼šåˆç´šã€‘
- ã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„çŠ¶æ³
- è«–ç†çš„ãªé£›èºãŒå°‘ãªã„
- 5ã€œ10å›ç¨‹åº¦ã®è³ªå•ã§è§£ã‘ã‚‹
- æ—¥å¸¸çš„ãªã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³`
      },
      normal: {
        label: 'ä¸­ç´š',
        prompt: `ã€é›£æ˜“åº¦ï¼šä¸­ç´šã€‘
- ã‚„ã‚„è¤‡é›‘ãªçŠ¶æ³è¨­å®š
- å°‘ã—ã²ã­ã‚Šã®ã‚ã‚‹å±•é–‹
- 10ã€œ20å›ç¨‹åº¦ã®è³ªå•ã§è§£ã‘ã‚‹
- æ„å¤–æ€§ã®ã‚ã‚‹çœŸç›¸`
      },
      hard: {
        label: 'ä¸Šç´š',
        prompt: `ã€é›£æ˜“åº¦ï¼šä¸Šç´šã€‘
- éå¸¸ã«ä¸å¯è§£ã§è¤‡é›‘ãªçŠ¶æ³
- å¤§ããªç™ºæƒ³ã®è»¢æ›ãŒå¿…è¦
- 20å›ä»¥ä¸Šã®è³ªå•ãŒå¿…è¦ã«ãªã‚‹ã“ã¨ã‚‚
- é©šãã®çœŸç›¸ã€å“²å­¦çš„ãƒ»å¿ƒç†çš„ãªæ·±ã¿`
      }
    };

    // DOM Elements
    const screens = {
      start: document.getElementById('start-screen'),
      game: document.getElementById('game-screen'),
      result: document.getElementById('result-screen')
    };

    const elements = {
      startBtn: document.getElementById('start-btn'),
      problemText: document.getElementById('problem-text'),
      questionInput: document.getElementById('question-input'),
      sendBtn: document.getElementById('send-btn'),
      questionCount: document.getElementById('question-count'),
      historyList: document.getElementById('history-list'),
      hintBtn: document.getElementById('hint-btn'),
      answerBtn: document.getElementById('answer-btn'),
      giveupBtn: document.getElementById('giveup-btn'),
      resultIcon: document.getElementById('result-icon'),
      resultTitle: document.getElementById('result-title'),
      answerText: document.getElementById('answer-text'),
      finalQuestionCount: document.getElementById('final-question-count'),
      yesCount: document.getElementById('yes-count'),
      noCount: document.getElementById('no-count'),
      nextBtn: document.getElementById('next-btn'),
      toast: document.getElementById('toast'),
      guessModal: document.getElementById('guess-modal'),
      guessInput: document.getElementById('guess-input'),
      guessCancel: document.getElementById('guess-cancel'),
      guessSubmit: document.getElementById('guess-submit')
    };

    // Toast notification
    function showToast(message, isSuccess = false) {
      elements.toast.textContent = message;
      elements.toast.className = 'toast show' + (isSuccess ? ' success' : '');
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, 4000);
    }

    // Initialize background animation
    function initBgAnimation() {
      const container = document.getElementById('bg-animation');
      if (!container) return;
      for (let i = 0; i < 15; i++) {
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const size = Math.random() * 100 + 50;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${Math.random() * 100}%`;
        bubble.style.animationDuration = `${Math.random() * 20 + 15}s`;
        bubble.style.animationDelay = `${Math.random() * 10}s`;
        container.appendChild(bubble);
      }
    }

    // Show screen
    function showScreen(screenName) {
      Object.values(screens).forEach(screen => screen?.classList.remove('active'));
      screens[screenName]?.classList.add('active');
    }

    // Call API
    async function callAPI(messages) {
      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      if (!data.choices || data.choices.length === 0) {
        throw new Error('AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      }

      return data.choices[0].message.content;
    }

    // Generate new problem
    async function generateProblem() {
      if (gameState.isLoading) return;

      gameState.isLoading = true;
      elements.startBtn.disabled = true;
      const originalText = elements.startBtn.innerHTML;
      elements.startBtn.innerHTML = 'ç”Ÿæˆä¸­<span class="loading-dots"><span></span><span></span><span></span></span>';

      try {
        const diffConfig = difficultyConfig[gameState.difficulty];
        const prompt = `ã‚ãªãŸã¯ã€Œã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—ã€ï¼ˆæ°´å¹³æ€è€ƒã‚¯ã‚¤ã‚ºï¼‰ã®å‡ºé¡Œè€…ã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã§æ–°ã—ã„å•é¡Œã‚’1ã¤ä½œæˆã—ã¦ãã ã•ã„ï¼š

${diffConfig.prompt}

ã€å…±é€šæ¡ä»¶ã€‘
- ä¸€è¦‹ä¸å¯è§£ã§èˆˆå‘³ã‚’å¼•ãçŠ¶æ³ã‚’æç¤º
- è«–ç†çš„ã«è§£æ±ºå¯èƒ½ãªè¬
- ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ã®è³ªå•ã§çœŸç›¸ã«è¾¿ã‚Šç€ã‘ã‚‹
- æ—¥æœ¬èªã§è‡ªç„¶ãªæ–‡ç« 
- ãƒ¦ãƒ‹ãƒ¼ã‚¯ã§å‰µé€ çš„ãªè¨­å®š

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
{
  "problem": "å•é¡Œæ–‡ï¼ˆä¸å¯è§£ãªçŠ¶æ³ã®æå†™ï¼‰",
  "answer": "çœŸç›¸ï¼ˆãªãœãã®çŠ¶æ³ãŒèµ·ããŸã®ã‹ã®èª¬æ˜ï¼‰"
}

JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

        const messages = [
          { role: 'system', content: 'ã‚ãªãŸã¯å‰µé€ çš„ãªæ°´å¹³æ€è€ƒã‚¯ã‚¤ã‚ºã®ä½œå®¶ã§ã™ã€‚' },
          { role: 'user', content: prompt }
        ];

        const response = await callAPI(messages);
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('AIã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™');

        const parsed = JSON.parse(jsonMatch[0]);
        gameState.problem = parsed.problem;
        gameState.answer = parsed.answer;
        gameState.questionCount = 0;
        gameState.yesCount = 0;
        gameState.noCount = 0;
        gameState.history = [];

        elements.problemText.textContent = gameState.problem;
        elements.questionCount.textContent = '0';
        elements.historyList.innerHTML = '';

        showScreen('game');
      } catch (error) {
        showToast('å•é¡Œã®ç”Ÿæˆã«å¤±æ•—: ' + error.message);
        console.error(error);
      } finally {
        gameState.isLoading = false;
        elements.startBtn.disabled = false;
        elements.startBtn.innerHTML = originalText;
      }
    }

    // Process question
    async function processQuestion(question, isGuess = false) {
      if (gameState.isLoading || !question.trim()) return;

      gameState.isLoading = true;
      elements.sendBtn.disabled = true;
      elements.questionInput.disabled = true;
      elements.hintBtn.disabled = true;
      elements.answerBtn.disabled = true;
      elements.giveupBtn.disabled = true;

      try {
        const prompt = isGuess ?
          `ã‚ãªãŸã¯ã€Œã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—ã€ã®å‡ºé¡Œè€…ã§ã™ã€‚

ã€å•é¡Œã€‘
${gameState.problem}

ã€çœŸç›¸ã€‘
${gameState.answer}

ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ç†ã€‘
${question}

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ç†ãŒçœŸç›¸ã¨æ¦‚ã­ä¸€è‡´ã—ã¦ã„ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„ã€‚
å®Œå…¨ã«åŒã˜ã§ãªãã¦ã‚‚ã€æ ¸å¿ƒçš„ãªéƒ¨åˆ†ãŒåˆã£ã¦ã„ã‚Œã°æ­£è§£ã¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ï¼š
{
  "isCorrect": true ã¾ãŸã¯ false,
  "feedback": "æ­£è§£ã®å ´åˆã¯ç¥ç¦ã®è¨€è‘‰ã€ä¸æ­£è§£ã®å ´åˆã¯ã€Œã‚‚ã†å°‘ã—è³ªå•ã‚’é‡ã­ã¦ã¿ã¾ã—ã‚‡ã†ã€ã¨ã„ã†åŠ±ã¾ã—"
}`
          :
          `ã‚ãªãŸã¯ã€Œã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—ã€ã®å‡ºé¡Œè€…ã§ã™ã€‚

ã€å•é¡Œã€‘
${gameState.problem}

ã€çœŸç›¸ã€‘
${gameState.answer}

ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è³ªå•ã€‘
${question}

ã“ã®è³ªå•ã«å¯¾ã—ã¦ã€çœŸç›¸ã‚’è¸ã¾ãˆã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚

å›ç­”ã¯å¿…ãšä»¥ä¸‹ã®ã„ãšã‚Œã‹ï¼š
- ã€Œã¯ã„ã€- è³ªå•ã®å†…å®¹ãŒçœŸç›¸ã«ãŠã„ã¦æ­£ã—ã„å ´åˆ
- ã€Œã„ã„ãˆã€- è³ªå•ã®å†…å®¹ãŒçœŸç›¸ã«ãŠã„ã¦æ­£ã—ããªã„å ´åˆ  
- ã€Œã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆã¾ã›ã‚“ã€- çœŸç›¸ã¨é–¢ä¿‚ãªã„ã€ã¾ãŸã¯åˆ¤æ–­ã§ããªã„å ´åˆ

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ï¼š
{
  "answer": "ã¯ã„" ã¾ãŸã¯ "ã„ã„ãˆ" ã¾ãŸã¯ "ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆã¾ã›ã‚“",
  "comment": "å¿…è¦ã«å¿œã˜ã¦ç°¡æ½”ãªè£œè¶³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
}`;

        const messages = [
          { role: 'system', content: 'ã‚ãªãŸã¯å…¬æ­£ã§è«–ç†çš„ãªã‚¯ã‚¤ã‚ºã®å‡ºé¡Œè€…ã§ã™ã€‚' },
          { role: 'user', content: prompt }
        ];

        const response = await callAPI(messages);
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('AIã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™');

        const parsed = JSON.parse(jsonMatch[0]);

        if (isGuess) {
          if (parsed.isCorrect) {
            showResult(true);
          } else {
            addHistoryItem(question, 'ä¸æ­£è§£', 'maybe');
            showToast(parsed.feedback || 'ã‚‚ã†å°‘ã—è³ªå•ã‚’é‡ã­ã¦ã¿ã¾ã—ã‚‡ã†ï¼');
          }
        } else {
          gameState.questionCount++;
          elements.questionCount.textContent = gameState.questionCount;

          let answerType = 'maybe';
          let displayAnswer = parsed.answer;

          if (parsed.answer.includes('ã¯ã„')) {
            answerType = 'yes';
            gameState.yesCount++;
            displayAnswer = 'ã¯ã„';
          } else if (parsed.answer.includes('ã„ã„ãˆ')) {
            answerType = 'no';
            gameState.noCount++;
            displayAnswer = 'ã„ã„ãˆ';
          } else {
            displayAnswer = 'ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆã¾ã›ã‚“';
          }

          addHistoryItem(question, displayAnswer, answerType);
        }

        elements.questionInput.value = '';
      } catch (error) {
        showToast('å›ç­”ã®å–å¾—ã«å¤±æ•—: ' + error.message);
        console.error(error);
      } finally {
        gameState.isLoading = false;
        elements.sendBtn.disabled = false;
        elements.questionInput.disabled = false;
        elements.hintBtn.disabled = false;
        elements.answerBtn.disabled = false;
        elements.giveupBtn.disabled = false;
        elements.questionInput.focus();
      }
    }

    // Add history item
    function addHistoryItem(question, answer, type) {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <div class="history-q">${escapeHtml(question)}</div>
        <div class="history-a ${type}">${answer}</div>
      `;
      elements.historyList.insertBefore(item, elements.historyList.firstChild);
      gameState.history.push({ question, answer, type });
    }

    // Get hint
    async function getHint() {
      if (gameState.isLoading) return;

      gameState.isLoading = true;
      elements.hintBtn.disabled = true;
      const originalText = elements.hintBtn.innerHTML;
      elements.hintBtn.innerHTML = 'ğŸ’¡ è€ƒãˆä¸­...';

      try {
        const prompt = `ã‚ãªãŸã¯ã€Œã‚¦ãƒŸã‚¬ãƒ¡ã®ã‚¹ãƒ¼ãƒ—ã€ã®å‡ºé¡Œè€…ã§ã™ã€‚

ã€å•é¡Œã€‘
${gameState.problem}

ã€çœŸç›¸ã€‘
${gameState.answer}

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãƒ’ãƒ³ãƒˆã‚’1ã¤ä¸ãˆã¦ãã ã•ã„ã€‚
- ç›´æ¥ç­”ãˆã‚’è¨€ã‚ãªã„
- è€ƒãˆã‚‹æ–¹å‘æ€§ã‚’ç¤ºå”†ã™ã‚‹
- 1ã€œ2æ–‡ç¨‹åº¦ã§ç°¡æ½”ã«`;

        const messages = [
          { role: 'system', content: 'ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¯ã‚¤ã‚ºã®å‡ºé¡Œè€…ã§ã™ã€‚' },
          { role: 'user', content: prompt }
        ];

        const response = await callAPI(messages);
        showToast(`ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ${response}`, true);
      } catch (error) {
        showToast('ãƒ’ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—: ' + error.message);
        console.error(error);
      } finally {
        gameState.isLoading = false;
        elements.hintBtn.disabled = false;
        elements.hintBtn.innerHTML = originalText;
      }
    }

    // Show result
    function showResult(isCorrect) {
      elements.resultIcon.textContent = isCorrect ? 'ğŸ‰' : 'ğŸ¤”';
      elements.resultTitle.textContent = isCorrect ? 'æ­£è§£ï¼ãŠã‚ã§ã¨ã†ï¼' : 'æ®‹å¿µ...ã‚®ãƒ–ã‚¢ãƒƒãƒ—';
      elements.resultTitle.className = `result-title ${isCorrect ? '' : 'giveup'}`;
      elements.answerText.textContent = gameState.answer;
      elements.finalQuestionCount.textContent = gameState.questionCount;
      elements.yesCount.textContent = gameState.yesCount;
      elements.noCount.textContent = gameState.noCount;
      showScreen('result');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event Listeners
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        gameState.difficulty = btn.dataset.difficulty;
      });
    });

    elements.startBtn?.addEventListener('click', generateProblem);

    elements.sendBtn?.addEventListener('click', () => {
      processQuestion(elements.questionInput.value);
    });

    elements.questionInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        processQuestion(elements.questionInput.value);
      }
    });

    elements.hintBtn?.addEventListener('click', getHint);

    elements.answerBtn?.addEventListener('click', () => {
      elements.guessInput.value = '';
      elements.guessModal.classList.add('active');
      elements.guessInput.focus();
    });

    elements.guessCancel?.addEventListener('click', () => {
      elements.guessModal.classList.remove('active');
    });

    elements.guessSubmit?.addEventListener('click', () => {
      const guess = elements.guessInput.value.trim();
      if (guess) {
        elements.guessModal.classList.remove('active');
        processQuestion(guess, true);
      }
    });

    elements.guessModal?.addEventListener('click', (e) => {
      if (e.target === elements.guessModal) {
        elements.guessModal.classList.remove('active');
      }
    });

    elements.giveupBtn?.addEventListener('click', () => {
      if (confirm('ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿæ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚')) {
        showResult(false);
      }
    });

    elements.nextBtn?.addEventListener('click', () => {
      showScreen('start');
    });

    // Initialize
    initBgAnimation();
  </script>
</body>

</html>